{{> header}}

<body>

<link rel="stylesheet" href="//rawgithub.com/Caged/d3-tip/master/examples/example-styles.css">


  <!-- JvectorMap -->
  <link rel="stylesheet" href="jvectormap/jquery-jvectormap-2.0.3.css" type="text/css" media="screen"/>
  <script src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
  <script src="jvectormap/jquery-jvectormap-2.0.3.min.js"></script>
  <script src="jvectormap/jquery-jvectormap-world-mill.js"></script>
  <script src="jvectormap/jquery-jvectormap-us-aea.js"></script>
  <script src="jvectormap/jquery-jvectormap-ca-lcc.js"></script>
  <script src="jvectormap/jquery-jvectormap-de-mill.js"></script>
  <script src="jvectormap/jquery-jvectormap-uk_regions-mill.js"></script>
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
  <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.1.4/Chart.min.js"></script>
  <script src="https://code.jquery.com/jquery-2.2.0.min.js"></script>

  <script>
      // Parameters
      const backgroundColor = '#08101c';
      const borderColor = '#4772b8';
  </script>


  <!-- Navbar -->
    <div class="navbar">
        <table class="navbar">
            <tr class="navbar">
                <td class="navbar-icon">
                    <a href="index.html">
                        <img class="navbar-logo" src="images/logo/logo-medium.png" alt="logo">
                    </a>
                </td>
                <td class="navbar-word">
                    <a href="statistics">
                        <p class="navbar">
                            STATISTICS
                        </p>
                    </a>
                </td>
                <td class="navbar-word">
                    <a href="pittsburgh">
                        <p class="navbar-current">
                            PITTSBURGH
                        </p>
                    </a>
                </td>
                <td class="navbar-word">
                    <a href="">
                        <p class="navbar">
                            ABOUT
                        </p>
                    </a>
                </td>
                <td class="navbar-word">
                    <a href="about">
                        <p class="navbar">
                            ABOUT
                        </p>
                    </a>
                </td>
            </tr>
        </table>


        <!-- I love the slim seprator line generated in this way -->
        <div style="height:0;overflow:hiddne;border-top:1px solid #DBDBDB" class="separator"></div>
    </div>

    <!-- Middle -->
    <div class="grey-canvas">

        <div class="fixed-form-div">
            <table class="body-item-1">
                <tr class="body-item">
                    <td class="body-item">
                        <p class="body-item-title-school">
                            ENTER THE NAME OF YOUR FAVORITE RESTAURANT
                        </p>
                    </td>
                </tr>
            </table>
            <table class="body-item-2">
                <tr class="body-item">
                    <td class="body-item">
                        <form action="restaurants_recommendation_by_name" method="GET">
                            <div>
                                <table>
                                    <tr>
                                        <td>
                                            <p class="body-item-content-first">Restaurant Name:</p>
                                        </td>
                                        <td>
                                            <input id="restaurants-name-input" class="body-item-content" type="text" name="restaurant_name" value="{{restaurant_name}}"/>
                                        </td>
                                        <td></td>
                                        <td>
                                            <p class="body-item-content">Key Words:</p>
                                        </td>
                                        <td>
                                            <input id="key-words-input" class="body-item-content" type="text" name="key_words_input" value=""/>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td id="append-first-column-here">
                                        </td>
                                        <td id="append-second-column-here">
                                        </td>
                                        <td></td>
                                        <td>
                                            <div>
                                                <input class="submit-button" type="submit" value="Get Similar Restaurants!" />
                                            </div>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </form>
                    </td>
                </tr>
            </table>
        </div>


        <script type="text/javascript">
            // Use dictionary to remove duplicate key words
            var dic = {};
            var url_para = {};
            $(document).ready(function () {
                // Get parameters in URL
                var url = window.location.search.substring(1).replace(/\+/g, ' ');
                var paras = url.split('&');
                // console.log(paras);
                for (var i = 0; i < paras.length; i++) {
                    var para = paras[i];
                    var name = paras[i].split('=')[0].trim();
                    var val = paras[i].split('=')[1].trim();
                    if (!isNaN(val)) {
                        val = parseInt(val);
                    }
                    url_para[name] = val;
                }
                // console.log(url_para);

                // Create slide bar from the url
                for (key in url_para) {
                    if (!key.startsWith('key_word_')) {
                        continue;
                    }
                    var word = key.substring(9).trim().toLowerCase();
                    if (word.length == 0) {
                        continue;
                    }

                    dic[word] = 1;
                    // Add slide bar
                    var first_row = `<p class="body-item-content">${word}:</p>`;
                    var second_row = `<p class="body-item-content">0<input onchange="updateRecommentaion(this.value)" name="key_word_${word}" type="range" min="0" max="10" value="${url_para[key]}"/>10</p>`;
                    $('#append-br-here').append("<br /><br /><br />");
                    $('#append-first-column-here').append(first_row);
                    $('#append-second-column-here').append(second_row);
                    $('#key-words-input').val('');
                }


                // If the user Added Space, then create slide bar
                $('#key-words-input').keypress(function(e) {
                    if (e.keyCode == 0 || e.keyCode == 32) {
                         // `0` works in mozilla and `320 in other`
                         console.log('space pressed');
                         var key_word = String($('#key-words-input').val()).trim().toLowerCase();
                         if (key_word.length == 0 || key_word in dic) {
                             return;
                         }

                         dic[key_word] = 1;
                         // Add slide bar
                         var first_row = `<p class="body-item-content">${key_word}:</p>`;
                         var second_row = `<p class="body-item-content">0<input onchange="updateRecommentaion(this.value)" name="key_word_${key_word}" type="range" min="0" max="10"/>10</p>`;
                         $('#append-br-here').append("<br /><br /><br />");
                         $('#append-first-column-here').append(first_row);
                         $('#append-second-column-here').append(second_row);
                         $('#key-words-input').val('');
                    }
                });
            });
        </script>

        <script type="text/javascript">
            $(document).ready(function () {
                $('.body-item-content').mouseup(function() {
                    var key_word = '';

                    // Get selection area
                    if (window.getSelection) {
                        key_word = window.getSelection().toString();
                    } else if (document.selection) {
                        key_word = document.selection.createRange().text.toString();
                    }

                    key_word = key_word.trim().toLowerCase();
                    if (key_word.length == 0 || key_word in dic) {
                        return;
                    }

                    dic[key_word] = 1;

                    // Add slide bar
                    var first_row = `<p class="body-item-content">${key_word}:</p>`;
                    var second_row = `<p class="body-item-content">0<input onchange="updateRecommentaion(this.value)" class="range" name="key_word_${key_word}" type="range" min="0" max="10"/>10</p>`;
                    $('#append-br-here').append("<br /><br /><br />");
                    $('#append-first-column-here').append(first_row);
                    $('#append-second-column-here').append(second_row);
                });
            });
        </script>

        <script type="text/javascript">
            // Send HTTP request to update similarity
            function updateRecommentaion(value) {
                // Add all data to dictionary
                var data = {};
                $("input[type='range']").each(function() {
                    data[$(this).attr("name")] = $(this).val();
                });
                data['restaurant_name'] = $('#restaurants-name-input').val();
                data['key_words_input'] = $('#key-words-input').val();

                // console.log(data);
                $.get('similar_restaurants_jquery', data, function(response) {
                    // console.log(response.message.replace(/"/g, "") === 'SUCCESS');
                    if (response == null || response.message.replace(/"/g, "") !== 'SUCCESS') {
                        return;
                    }

                    var recommendation_list = JSON.parse(response.recommendation_list);
                    if (recommendation_list) {
                        for (var i = 0; i < recommendation_list.length; i++) {
                            var business_id = recommendation_list[i].split('\t')[0];
                            var name = recommendation_list[i].split('\t')[1];
                            var score = recommendation_list[i].split('\t')[2];
                            // console.log(business_id);
                            // console.log(name);
                            // console.log(score);
                            $(`#${i+1}_recommendation`).attr('href', `/reviews/business_id?business_id=${business_id}&name=${name}&key_words=`);
                            $(`#${i+1}_recommendation`).html(`${name}`);

                            var output = `Total score: ${score}&emsp;`;
                            if (recommendation_list[i].split('\t').length > 3) {
                                var scores = recommendation_list[i].split('\t')[3].split(';');
                                // console.log(scores);
                                for (var j = 0; j < scores.length; j++) {
                                    output += scores[j].split(':')[0] + ' Score:&nbsp;' + scores[j].split(':')[1] + '&emsp;';
                                }
                            }
                            $(`#${i+1}_recommendation_score`).html(output);
                        }
                    }
                });
            }
        </script>

        <div id="append-br-here"></div>
        <br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br />
        <div id="append-here"></div>

    </div>
    <!-- <script>
        $("#test").dblclick(function(){
            alert("The paragraph was double-clicked");
        });
    </script> -->

    <script src="https://code.jquery.com/jquery-2.2.0.min.js"></script>

    <div id="div_message" style="display: none;" width="100%">{{message}}</div>
    <div id="div_reviews" style="display: none;" width="100%">{{reviews}}</div>
    <div id="div_key_words" style="display: none;" width="100%">{{key_words}}</div>
    <div id="div_recommendation" style="display: none;" width="100%">{{recommendation_list}}</div>
    <!-- <h3>Name: {{restaurant_name}}</h3> -->

    <script type="text/javascript">
    // Show the search result
        var output = '';
        if ($('#div_message').text() === '' || JSON.parse($('#div_message').text()) !== 'SUCCESS') {
            output += '<br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br />';
        } else {
            const MAX_CHAR_EACH_LINE = 85;
            var reviews = JSON.parse($('#div_reviews').text());
            var message = JSON.parse($('#div_message').text());
            var recommendation_list = JSON.parse($('#div_recommendation').text());
            var key_words = $('#div_key_words').text().split(' ');
            var dic_key_words = {}
            for (var i = 0; i < key_words.length; i++) {
                var word = key_words[i].trim().toLowerCase();
                if (word.lenght == 0) {
                    continue;
                }
                dic_key_words[word] = 1;
            }
            if (dic_key_words) {
                dic_key_words = dic;
                var str_dic_key_words = JSON.stringify(dic_key_words).replace(/"/g, "'");
            }
            // console.log(message);
            // if (message) {
            //     output += '<h3> Message:       ' + message + '</h3>';
            // }
            //
            // output += '<br />';

            if (recommendation_list) {
                output += '<table class="body-item-1">\
                                <tr class="body-item">\
                                    <td class="body-item">\
                                        <p class="body-item-title-school">\
                                            SIMILAR RESTAURANTS\
                                        </p>\
                                    </td>\
                                </tr>\
                            </table>';
                for (var i = 0; i < recommendation_list.length; i++) {
                    output += '<table class="body-item-2">\
                            <tr class="body-item">\
                                <td class="body-item">';
                    var business_id = recommendation_list[i].split('\t')[0];
                    var name = recommendation_list[i].split('\t')[1];
                    var score = recommendation_list[i].split('\t')[2];
                    output += '<br />';
                    output += `<p class="body-item-content-first">${i+1}. <a id="${i+1}_recommendation" href="/reviews/business_id?business_id=${business_id}&name=${name}&key_words=${str_dic_key_words}" class="school-name">${name}</a>:</p>`;
                    output += `<p class="body-item-content" id="${i+1}_recommendation_score">Total Score: ${score}&emsp;`;

                    if (recommendation_list[i].split('\t').length > 3) {
                        var scores = recommendation_list[i].split('\t')[3].split(';');
                        for (var j = 0; j < scores.length; j++) {
                            output += scores[j].split(':')[0] + ' Score:&nbsp;' + scores[j].split(':')[1] + '&emsp;';
                        }
                    }
                    output += '</p>';
                    output += '<br />';
                    output += '     </td>\
                                </tr>\
                            </table>';
                }
            }

            if (reviews) {
                output += '<table class="body-item-1">\
                                <tr class="body-item">\
                                    <td class="body-item">\
                                        <p class="body-item-title-school">\
                                            ALL REVIEWS OF THE SELECTED RESTAURANT\
                                        </p>\
                                    </td>\
                                </tr>\
                            </table>';
                for (var i = 0; i < reviews.length; i++) {
                    output += '<table class="body-item-2">\
                                <tr class="body-item">\
                                    <td class="body-item">';
                    output += '<ul>';

                    output += '<p class="body-item-content-first">';

                    // Add stars
                    var j = 0;
                    for (; j < reviews[i].stars ; j++) {
                        output += '<img src="/images/icons/star.png" class="star-icon"/>';
                    }
                    for (; j < 5; j++) {
                        output += '<img src="/images/icons/star-grey.png" class="star-icon"/>';
                    }

                    output += `${reviews[i].date}</p>`;
                    if (dic_key_words) {
                        var words = reviews[i].text.split(" ");
                        output += '<p class="body-item-content">';
                        var curr_len = 0;
                        for (var j in words) {
                            var word = words[j].replace(/[^A-Za-z0-9]/gi, '');

                            if (curr_len + word.length + 1 > MAX_CHAR_EACH_LINE) {
                                output += '<br />';
                                curr_len = 0;
                            }
                            curr_len += word.length + 1;

                            if (word.toLowerCase() in dic_key_words) {
                                // console.log('Found a word in dictionary');
                                // console.log(word);
                                output += '<span style="background-color:yellow">' + words[j] + '</span>';
                            } else {
                                output += words[j];
                            }
                            output += '&nbsp;'
                        }
                        output += '</p>';
                    }
                    output += '<p class="body-item-content">';
                    output += '<img src="/images/icons/bulb.png" class="other-icon"/>&nbsp;' + reviews[i].num_useful;
                    output += '<img src="/images/icons/funny.png" class="other-icon"/>&nbsp;' + reviews[i].num_funny;
                    output += '<img src="/images/icons/cool.png" class="other-icon"/>&nbsp;' + reviews[i].num_cool;
                    output += '</p>';
                    output += '     </td>\
                                </tr>\
                            </table>';
                }
            }
            output += '<br /><br /><br /><br />';
        }
        $('#append-here').append(output);
    </script>



{{> footer}}
