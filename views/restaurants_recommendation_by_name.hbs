{{> header}}

<body>

<link rel="stylesheet" href="//rawgithub.com/Caged/d3-tip/master/examples/example-styles.css">


  <!-- JvectorMap -->
  <link rel="stylesheet" href="jvectormap/jquery-jvectormap-2.0.3.css" type="text/css" media="screen"/>
  <script src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
  <script src="jvectormap/jquery-jvectormap-2.0.3.min.js"></script>
  <script src="jvectormap/jquery-jvectormap-world-mill.js"></script>
  <script src="jvectormap/jquery-jvectormap-us-aea.js"></script>
  <script src="jvectormap/jquery-jvectormap-ca-lcc.js"></script>
  <script src="jvectormap/jquery-jvectormap-de-mill.js"></script>
  <script src="jvectormap/jquery-jvectormap-uk_regions-mill.js"></script>
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
  <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.1.4/Chart.min.js"></script>
  <script src="https://code.jquery.com/jquery-2.2.0.min.js"></script>

  <script>
      // Parameters
      const backgroundColor = '#08101c';
      const borderColor = '#4772b8';
  </script>


  <!-- Navbar -->
    <div class="navbar">
        <table class="navbar">
            <tr class="navbar">
                <td class="navbar-icon">
                    <a href="index.html">
                        <img class="navbar-logo" src="images/logo/logo-medium.png" alt="logo">
                    </a>
                </td>
                <td class="navbar-word">
                    <a href="statistics">
                        <p class="navbar">
                            STATISTICS
                        </p>
                    </a>
                </td>
                <td class="navbar-word">
                    <a href="pittsburgh">
                        <p class="navbar-current">
                            PITTSBURGH
                        </p>
                    </a>
                </td>
                <td class="navbar-word">
                    <a href="">
                        <p class="navbar">
                            ABOUT
                        </p>
                    </a>
                </td>
                <td class="navbar-word">
                    <a href="about">
                        <p class="navbar">
                            ABOUT
                        </p>
                    </a>
                </td>
            </tr>
        </table>


        <!-- I love the slim seprator line generated in this way -->
        <div style="height:0;overflow:hiddne;border-top:1px solid #DBDBDB" class="separator"></div>
    </div>

    <!-- Middle -->
    <div class="grey-canvas">

        <div class="fixed-form-div">
            <table class="body-item-1">
                <tr class="body-item">
                    <td class="body-item">
                        <p class="body-item-title-school">
                            ENTER THE NAME OF YOUR FAVORITE RESTAURANT
                        </p>
                    </td>
                </tr>
            </table>
            <table class="body-item-2">
                <tr class="body-item">
                    <td class="body-item">
                        <form action="restaurants_recommendation_by_name" method="GET">
                            <div>
                                <table>
                                    <tr>
                                        <td>
                                            <p class="body-item-content-first">Restaurant Name:</p>
                                        </td>
                                        <td>
                                            <input id="restaurants-name-input" class="body-item-content" type="text" name="restaurant_name" value="{{restaurant_name}}"/>
                                        </td>
                                        <td></td>
                                        <td>
                                            <p class="body-item-content">Key Words:</p>
                                        </td>
                                        <td>
                                            <input id="key-words-input" class="body-item-content" type="text" name="key_words_input" value=""/>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td id="append-first-column-here">
                                        </td>
                                        <td id="append-second-column-here">
                                        </td>
                                        <td></td>
                                        <td>
                                            <div>
                                                <input class="submit-button" type="submit" value="Get Similar Restaurants!" />
                                            </div>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </form>
                    </td>
                </tr>
            </table>
            <table class="body-item-2">
                <tr class="body-item">
                    <td class="body-item">
                        <input id="url-text" type="input"></input>
                        <input type="button" class="copy-url-button" value="Copy URL To Clipboard" onclick="CopyURLToClipboard();" />
                    </td>
                </tr>
            </table>
        </div>


        <script type="text/javascript">
            // Use dictionary to remove duplicate key words
            var dic = {};
            var url_para = {};
            $(document).ready(function () {
                $('#url-text').val(window.location.href);

                // Get parameters in URL
                var url = window.location.search.substring(1).replace(/\+/g, ' ');
                if (url.length > 0) {
                    var paras = url.split('&');
                    console.log(paras);
                    for (var i = 0; i < paras.length; i++) {
                        var para = paras[i];
                        var name = paras[i].split('=')[0].trim();
                        var val = paras[i].split('=')[1].trim();
                        if (!isNaN(val)) {
                            val = parseInt(val);
                        }
                        url_para[name] = val;
                    }
                    // console.log(url_para);

                    // Create slide bar from the url
                    for (key in url_para) {
                        if (!key.startsWith('key_word_')) {
                            continue;
                        }
                        var word = key.substring(9).trim().toLowerCase().replace(/[^A-Za-z0-9]/gi, '');
                        if (word.length == 0) {
                            continue;
                        }

                        dic[word] = 1;
                        // Add slide bar
                        var first_row = `<p class="body-item-content">${word}:</p>`;
                        var second_row = `<p class="body-item-content">0<input onchange="updateRecommentaion()" name="key_word_${word}" type="range" min="0" max="10" value="${url_para[key]}"/>10</p>`;
                        $('#append-br-here').append("<br /><br /><br />");
                        $('#append-first-column-here').append(first_row);
                        $('#append-second-column-here').append(second_row);
                        $('#key-words-input').val('');

                        updateRecommentaion();
                    }
                }



                // If the user Added Space, then create slide bar
                $('#key-words-input').on('input', function(e) {
                    var text = $('#key-words-input').val();
                    if (text.charAt(text.length - 1) == ' ') {
                         // `0` works in mozilla and `320 in other`
                         console.log('space pressed');
                         var key_word = String(text).trim().toLowerCase().replace(/[^A-Za-z0-9]/gi, '');
                         if (key_word.length == 0 || key_word in dic) {
                             $('#key-words-input').val('');
                             return;
                         }

                         dic[key_word] = 1;
                         // Add slide bar
                         var first_row = `<p class="body-item-content">${key_word}:</p>`;
                         var second_row = `<p class="body-item-content">0<input onchange="updateRecommentaion()" name="key_word_${key_word}" type="range" min="0" max="10"/>10</p>`;
                         $('#append-br-here').append("<br /><br /><br />");
                         $('#append-first-column-here').append(first_row);
                         $('#append-second-column-here').append(second_row);
                         $('#key-words-input').val('');

                         updateRecommentaion();
                         updateCurrentPageUrl(key_word, 5);
                    }
                });
            });
        </script>

        <script type="text/javascript">
            $(document).ready(function () {
                // Add key words when a word is selected
                $('.body-item-content').mouseup(function() {
                    var key_word = '';

                    // Get selection area
                    if (window.getSelection) {
                        key_word = window.getSelection().toString();
                    } else if (document.selection) {
                        key_word = document.selection.createRange().text.toString();
                    }

                    key_word = key_word.trim().toLowerCase().replace(/[^A-Za-z0-9]/gi, '');
                    if (key_word.length == 0 || key_word in dic) {
                        return;
                    }

                    dic[key_word] = 1;

                    // Add slide bar
                    var first_row = `<p class="body-item-content">${key_word}:</p>`;
                    var second_row = `<p class="body-item-content">0<input onchange="updateRecommentaion()" class="range" name="key_word_${key_word}" type="range" min="0" max="10"/>10</p>`;
                    $('#append-br-here').append("<br /><br /><br />");
                    $('#append-first-column-here').append(first_row);
                    $('#append-second-column-here').append(second_row);

                    updateRecommentaion();
                    updateCurrentPageUrl(key_word, 5);
                });
            });
        </script>

        <script type="text/javascript">
            function CopyURLToClipboard() {
                var Url = $("#url-text");
                Url.val(window.location.href);
                Url.select();
                document.execCommand("copy");
            }

            function updateCurrentPageUrl(name, value) {
                console.log();
                var url = window.location.href;
                if (url.indexOf('?') == -1) {
                    url += '?';
                }
                url += '&key_word_' + name + '=' + value;
                // Update in this way can update the url without refreshing the page
                history.pushState(null, null, url);
            }

            // Highlight words
            function highlightWords(reviews, path) {
                // console.log(reviews);
                for (var i = 0; i < reviews.length; i++) {
                    var words = reviews[i].text.split(" ");
                    var output = '';
                    var curr_len = 0;
                    for (var j in words) {
                        var word = words[j].replace(/[^A-Za-z0-9]/gi, '');

                        if (curr_len + word.length + 1 > MAX_CHAR_EACH_LINE) {
                            output += '<br />';
                            curr_len = 0;
                        }
                        curr_len += word.length + 1;

                        if (word.toLowerCase() in dic) {
                            // console.log('Found a word in dictionary');
                            // console.log(word);
                            output += '<span style="background-color:yellow">' + words[j] + '</span>';
                        } else {
                            output += words[j];
                        }
                        output += '&nbsp;'
                    }
                    $(`#${i+1}_${path}`).html(output);
                }
            }

            // Send HTTP request to update similarity
            function updateRecommentaion() {
                // Add all data to dictionary
                var data = {};
                $("input[type='range']").each(function() {
                    data[$(this).attr("name")] = $(this).val();
                });
                data['restaurant_name'] = $('#restaurants-name-input').val();
                data['key_words_input'] = $('#key-words-input').val();
                data['reviews'] = reviews;

                // console.log(data);
                $.get('similar_restaurants_jquery', data, function(response) {
                    // console.log(response.message.replace(/"/g, "") === 'SUCCESS');
                    if (response == null || response.message.replace(/"/g, "") !== 'SUCCESS') {
                        return;
                    }

                    reviews = response.reviews;
                    highlightWords(reviews, 'review');

                    var recommendation_list = JSON.parse(response.recommendation_list);
                    var recommendation_reviews = JSON.parse(response.recommendation_reviews);
                    console.log(recommendation_reviews);
                    if (recommendation_list) {
                        for (var i = 0; i < recommendation_list.length; i++) {
                            var business_id = recommendation_list[i].split('\t')[0];
                            var name = recommendation_list[i].split('\t')[1];
                            var score = recommendation_list[i].split('\t')[2];
                            // console.log(business_id);
                            // console.log(name);
                            // console.log(score);
                            $(`#${i+1}_recommendation`).attr('href', `/reviews/business_id?business_id=${business_id}&name=${name}&key_words=`);
                            $(`#${i+1}_recommendation`).html(`${name}`);

                            var output = `Total score: ${score}&emsp;`;
                            if (recommendation_list[i].split('\t').length > 3) {
                                var scores = recommendation_list[i].split('\t')[3].split(';');
                                // console.log(scores);
                                for (var j = 0; j < scores.length; j++) {
                                    output += scores[j].split(':')[0] + ' Score:&nbsp;' + scores[j].split(':')[1] + '&emsp;';
                                }

                                var target_reviews = recommendation_reviews[business_id];
                                // console.log(target_reviews);
                                for (var j = 0; j < target_reviews.length; j++) {
                                    output += '<br /><br />';
                                    // Add stars
                                    var k = 0;
                                    for (; k < target_reviews[j].stars ; k++) {
                                        output += '<img src="/images/icons/star.png" class="star-icon"/>';
                                    }
                                    for (; k < 5; k++) {
                                        output += '<img src="/images/icons/star-grey.png" class="star-icon"/>';
                                    }
                                    output += `${target_reviews[j].date}<br />`;

                                    output += target_reviews[j].text + '<br />';

                                    output += '<img src="/images/icons/bulb.png" class="other-icon"/>&nbsp;' + reviews[i].num_useful;
                                    output += '<img src="/images/icons/funny.png" class="other-icon"/>&nbsp;' + reviews[i].num_funny;
                                    output += '<img src="/images/icons/cool.png" class="other-icon"/>&nbsp;' + reviews[i].num_cool;
                                }
                            }

                            $(`#${i+1}_recommendation_score`).html(output);

                            highlightWords(recommendation_reviews[business_id], 'recommendation_score');
                        }
                    }
                });
            }
        </script>

        <div id="append-br-here"></div>
        <br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br />
        <div id="append-here"></div>

    </div>
    <!-- <script>
        $("#test").dblclick(function(){
            alert("The paragraph was double-clicked");
        });
    </script> -->

    <script src="https://code.jquery.com/jquery-2.2.0.min.js"></script>

    <div id="div_message" style="display: none;" width="100%">{{message}}</div>
    <div id="div_reviews" style="display: none;" width="100%">{{reviews}}</div>
    <div id="div_key_words" style="display: none;" width="100%">{{key_words}}</div>
    <div id="div_recommendation" style="display: none;" width="100%">{{recommendation_list}}</div>
    <!-- <h3>Name: {{restaurant_name}}</h3> -->

    <script type="text/javascript">
    // Show the search result
        var output = '';
        const MAX_CHAR_EACH_LINE = 85;
        if ($('#div_message').text() === '' || JSON.parse($('#div_message').text()) !== 'SUCCESS') {
            output += '<br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br />';
        } else {
            if ($('#div_reviews').text().trim().length != 0) {
                var reviews = JSON.parse($('#div_reviews').text());
                var message = JSON.parse($('#div_message').text());
                var recommendation_list = JSON.parse($('#div_recommendation').text());
                var key_words = $('#div_key_words').text().split(' ');
                var dic_key_words = {}
                for (var i = 0; i < key_words.length; i++) {
                    var word = key_words[i].trim().toLowerCase();
                    if (word.lenght == 0) {
                        continue;
                    }
                    dic_key_words[word] = 1;
                }
                if (dic_key_words) {
                    dic_key_words = dic;
                    var str_dic_key_words = JSON.stringify(dic_key_words).replace(/"/g, "'");
                }
                // console.log(message);
                // if (message) {
                //     output += '<h3> Message:       ' + message + '</h3>';
                // }
                //
                // output += '<br />';

                if ($('#div_recommendation').text().trim().length > 2) {
                    console.log(111);
                    output += '<table class="body-item-1">\
                                    <tr class="body-item">\
                                        <td class="body-item">\
                                            <p class="body-item-title-school">\
                                                SIMILAR RESTAURANTS\
                                            </p>\
                                        </td>\
                                    </tr>\
                                </table>';
                    for (var i = 0; i < recommendation_list.length; i++) {
                        output += '<table class="body-item-2">\
                                <tr class="body-item">\
                                    <td class="body-item">';
                        var business_id = recommendation_list[i].split('\t')[0];
                        var name = recommendation_list[i].split('\t')[1];
                        var score = recommendation_list[i].split('\t')[2];
                        output += '<br />';
                        output += `<p class="body-item-content-first">${i+1}. <a name="load-more-reviews" id="${i+1}_recommendation" href="/get_top_reviews_business_id?business_id=${business_id}&begin_index=0&num_reviews=3" class="school-name">${name}</a></p>`;
                        output += `<p class="body-item-content" id="${i+1}_recommendation_score">Total Score: ${score}&emsp;`;
                        // output += `<input type="hidden" id="${i+1}_begin_index" value="0"></input>`;
                        // output += `<input type="hidden" id="${i+1}_num_reviews" value="3"></input>`;

                        if (recommendation_list[i].split('\t').length > 3) {
                            var scores = recommendation_list[i].split('\t')[3].split(';');
                            for (var j = 0; j < scores.length; j++) {
                                output += scores[j].split(':')[0] + ' Score:&nbsp;' + scores[j].split(':')[1] + '&emsp;';
                            }
                        }
                        output += '</p>';
                        output += '<br />';
                        output += '     </td>\
                                    </tr>\
                                </table>';
                    }
                } else {
                    console.log(222);
                    output += '<table class="body-item-1">\
                                    <tr class="body-item">\
                                        <td class="body-item">\
                                            <p class="body-item-title-school">\
                                                SIMILAR RESTAURANTS\
                                            </p>\
                                        </td>\
                                    </tr>\
                                </table>';
                    for (var i = 0; i < 10; i++) {
                        output += '<table class="body-item-2">\
                                <tr class="body-item">\
                                    <td class="body-item">';
                        output += '<br />';
                        output += `<p class="body-item-content-first">${i+1}. <a id="${i+1}_recommendation" href="" class="school-name"></a></p>`;
                        output += `<p class="body-item-content" id="${i+1}_recommendation_score">&emsp;`;
                        output += '</p>';
                        output += '<br />';
                        output += '     </td>\
                                    </tr>\
                                </table>';
                    }
                    output += '</p>';
                    output += '<br />';
                    output += '     </td>\
                                </tr>\
                            </table>';
                }

                if (reviews) {
                    output += '<table class="body-item-1">\
                                    <tr class="body-item">\
                                        <td class="body-item">\
                                            <p class="body-item-title-school">\
                                                ALL REVIEWS OF THE SELECTED RESTAURANT\
                                            </p>\
                                        </td>\
                                    </tr>\
                                </table>';
                    for (var i = 0; i < reviews.length; i++) {
                        output += '<table class="body-item-2">\
                                    <tr class="body-item">\
                                        <td class="body-item">';
                        output += '<ul>';

                        output += '<p class="body-item-content-first">';

                        // Add stars
                        var j = 0;
                        for (; j < reviews[i].stars ; j++) {
                            output += '<img src="/images/icons/star.png" class="star-icon"/>';
                        }
                        for (; j < 5; j++) {
                            output += '<img src="/images/icons/star-grey.png" class="star-icon"/>';
                        }

                        output += `${reviews[i].date}</p>`;
                        if (dic_key_words) {
                            var words = reviews[i].text.split(" ");
                            output += `<p class="body-item-content" id="${i+1}_review"name="reviews">`;
                            var curr_len = 0;
                            for (var j in words) {
                                var word = words[j].replace(/[^A-Za-z0-9]/gi, '');

                                if (curr_len + word.length + 1 > MAX_CHAR_EACH_LINE) {
                                    output += '<br />';
                                    curr_len = 0;
                                }
                                curr_len += word.length + 1;

                                if (word.toLowerCase() in dic_key_words) {
                                    // console.log('Found a word in dictionary');
                                    // console.log(word);
                                    output += '<span style="background-color:yellow">' + words[j] + '</span>';
                                } else {
                                    output += words[j];
                                }
                                output += '&nbsp;'
                            }
                            output += '</p>';
                        }
                        output += '<p class="body-item-content">';
                        output += '<img src="/images/icons/bulb.png" class="other-icon"/>&nbsp;' + reviews[i].num_useful;
                        output += '<img src="/images/icons/funny.png" class="other-icon"/>&nbsp;' + reviews[i].num_funny;
                        output += '<img src="/images/icons/cool.png" class="other-icon"/>&nbsp;' + reviews[i].num_cool;
                        output += '</p>';
                        output += '     </td>\
                                    </tr>\
                                </table>';
                    }
                }
                output += '<br /><br /><br /><br />';
            }
        }
        $('#append-here').append(output);
    </script>



{{> footer}}
